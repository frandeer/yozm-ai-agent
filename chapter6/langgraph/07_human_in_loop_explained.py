"""
ğŸ¯ Human-in-the-Loop (ì‚¬ëŒì´ ë£¨í”„ ì•ˆì— ìˆë‹¤!)
===============================================

í•µì‹¬ ê°œë…:
    AI ì—ì´ì „íŠ¸ê°€ ì‘ì—…ì„ ìˆ˜í–‰í•˜ë‹¤ê°€
    â†’ ì •ë³´ê°€ ë¶€ì¡±í•˜ë©´ ì‚¬ëŒì—ê²Œ ë¬¼ì–´ë³´ê³ 
    â†’ ì‚¬ëŒì˜ ë‹µë³€ì„ ë°›ì•„ì„œ
    â†’ ë‹¤ì‹œ ì‘ì—…ì„ ê³„ì† ì§„í–‰!
    
ì‹¤ìƒí™œ ë¹„ìœ :
    - ë ˆìŠ¤í† ë‘ì—ì„œ ì£¼ë¬¸í•  ë•Œ ì›¨ì´í„°ê°€ "ë§¤ìš´ ë§› ì–´ëŠ ì •ë„ë¡œ í•˜ì‹œê² ì–´ìš”?" ë¬¼ì–´ë³´ëŠ” ê²ƒ
    - ì˜ì‚¬ê°€ "ì–¸ì œë¶€í„° ì•„íŒ ë‚˜ìš”?" ì¶”ê°€ ì •ë³´ ë¬¼ì–´ë³´ëŠ” ê²ƒ
    - ì¹œêµ¬ê°€ "ëª‡ ì‹œì— ë§Œë‚ ê¹Œ?" ë¬¼ì–´ë³´ëŠ” ê²ƒ

ì´ ëª¨ë“  ìƒí™©ì—ì„œ ëŒ€í™” ì¤‘ê°„ì— ì‚¬ëŒì˜ ì…ë ¥ì´ í•„ìš”í•©ë‹ˆë‹¤!
"""

from typing import Literal
from langgraph.graph import StateGraph, START, END
from langchain.chat_models import init_chat_model
from pydantic import BaseModel, Field


# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# 1ï¸âƒ£ ìƒíƒœ ì •ì˜: ì›Œí¬í”Œë¡œìš° ì „ì²´ì—ì„œ ê³µìœ ë˜ëŠ” ì •ë³´
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
class AgentState(BaseModel):
    """ì—ì´ì „íŠ¸ì˜ ìƒíƒœë¥¼ ì •ì˜í•©ë‹ˆë‹¤."""
    
    user_message: str = Field(
        default="", 
        description="ì‚¬ìš©ìê°€ ì²˜ìŒì— ìš”ì²­í•œ ë‚´ìš© (ì˜ˆ: 'ë¸”ë¡œê·¸ ê¸€ ì‘ì„±')"
    )
    
    task_details: str = Field(
        default="", 
        description="ì‚¬ìš©ìê°€ ì¶”ê°€ë¡œ ì œê³µí•œ ìƒì„¸ ì •ë³´ (ì˜ˆ: 'íŒŒì´ì¬ íŠœí† ë¦¬ì–¼ì— ëŒ€í•œ ê¸€')"
    )
    
    response: str = Field(
        default="", 
        description="LLMì´ ìƒì„±í•œ ì‘ë‹µ (ì§ˆë¬¸ ë˜ëŠ” ìµœì¢… ë‹µë³€)"
    )
    
    interaction_count: int = Field(
        default=0,
        description="ì‚¬ëŒê³¼ ëª‡ ë²ˆ ëŒ€í™”í–ˆëŠ”ì§€ ì¶”ì "
    )


# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# 2ï¸âƒ£ ë…¸ë“œ 1: LLMì—ê²Œ ë¬¼ì–´ë³´ê¸°
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
def llm_node(state: AgentState, llm) -> dict:
    """
    ğŸ¤– AI(LLM)ê°€ ì‘ë‹µì„ ìƒì„±í•˜ëŠ” ë…¸ë“œ
    
    ì—­í• :
        - ìƒì„¸ ì •ë³´ê°€ ìˆìœ¼ë©´ â†’ ìµœì¢… ë‹µë³€ ìƒì„±
        - ìƒì„¸ ì •ë³´ê°€ ì—†ìœ¼ë©´ â†’ ì‚¬ìš©ìì—ê²Œ ì§ˆë¬¸ ìƒì„±
    
    ë¹„ìœ :
        ë ˆìŠ¤í† ë‘ ì›¨ì´í„°ê°€ ì£¼ë¬¸ì„ ë“£ê³ 
        "ë¬´ì—‡ì„ ë“œì‹œê² ì–´ìš”?" ë˜ëŠ” "ë§¤ìš´ë§›ì€ ì–´ëŠ ì •ë„ë¡œ í•˜ì‹œê² ì–´ìš”?" ë¬¼ì–´ë³´ëŠ” ê²ƒ
    """
    print("\n" + "="*60)
    print("ğŸ¤– [AI ë…¸ë“œ] LLMì´ ìƒê° ì¤‘...")
    print("="*60)
    
    # ìƒíƒœ í™•ì¸
    details = state.task_details
    task = state.user_message
    count = state.interaction_count
    
    print(f"ğŸ“Š í˜„ì¬ ìƒíƒœ:")
    print(f"   - ì´ˆê¸° ìš”ì²­: {task}")
    print(f"   - ë°›ì€ ìƒì„¸ì •ë³´: {details if details else '(ì•„ì§ ì—†ìŒ)'}")
    print(f"   - ëŒ€í™” íšŸìˆ˜: {count}íšŒ")
    
    # ì‹œë‚˜ë¦¬ì˜¤ ë¶„ê¸°
    if details:
        # ìƒì„¸ ì •ë³´ê°€ ìˆìœ¼ë©´ â†’ ìµœì¢… ë³´ê³ ì„œ ì‘ì„±
        print(f"\nâœ… ì¶©ë¶„í•œ ì •ë³´ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤! ìµœì¢… ë‹µë³€ì„ ìƒì„±í•©ë‹ˆë‹¤.")
        prompt = f"""ë‹¤ìŒ ìš”ì²­ì— ëŒ€í•œ ìƒì„¸í•œ ë³´ê³ ì„œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”:

ìš”ì²­: {task}
ìƒì„¸ ì •ë³´: {details}

3-4ë¬¸ì¥ìœ¼ë¡œ êµ¬ì²´ì ì¸ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ì„¸ìš”. ì§ˆë¬¸í•˜ì§€ ë§ê³  ìµœì¢… ë‹µë³€ë§Œ ì œê³µí•˜ì„¸ìš”."""
    else:
        # ìƒì„¸ ì •ë³´ê°€ ì—†ìœ¼ë©´ â†’ ì§ˆë¬¸ ìƒì„±
        print(f"\nâ“ ì •ë³´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. ì‚¬ìš©ìì—ê²Œ ì§ˆë¬¸ì„ ìƒì„±í•©ë‹ˆë‹¤.")
        prompt = f"""ì‚¬ìš©ìê°€ '{task}' ì‘ì—…ì„ ìš”ì²­í–ˆìŠµë‹ˆë‹¤.

ì´ ì‘ì—…ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ í•„ìš”í•œ ì •ë³´ë¥¼ ë¬¼ì–´ë³´ì„¸ìš”:
- ì–´ë–¤ ì£¼ì œ/ë‚´ìš©ì¸ì§€
- ì–´ë–¤ ìŠ¤íƒ€ì¼/í˜•ì‹ì¸ì§€
- ëˆ„êµ¬ë¥¼ ëŒ€ìƒìœ¼ë¡œ í•˜ëŠ”ì§€

ë°˜ë“œì‹œ ì§ˆë¬¸ì€ ë¬¼ìŒí‘œ('?')ë¡œ ëë‚´ì£¼ì„¸ìš”. í•œ ë²ˆì— 2-3ê°€ì§€ë¥¼ ë¬¼ì–´ë³´ì„¸ìš”."""
    
    # LLM í˜¸ì¶œ
    print(f"\nğŸ”„ LLMì—ê²Œ ìš”ì²­ ì¤‘...")
    response = llm.invoke(prompt).content
    
    print(f"\nğŸ’¬ LLM ì‘ë‹µ:")
    print(f"   {response}")
    print("="*60)
    
    return {
        "response": response,
        "task_details": "",  # ë‹¤ìŒ ì‚¬ì´í´ì„ ìœ„í•´ ì´ˆê¸°í™”
        "interaction_count": count + 1
    }


# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# 3ï¸âƒ£ ë…¸ë“œ 2: ì‚¬ëŒì—ê²Œ ë¬¼ì–´ë³´ê¸° (Human-in-the-Loopì˜ í•µì‹¬!)
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
def human_input_node(state: AgentState) -> dict:
    """
    ğŸ‘¤ ì‚¬ëŒì—ê²Œ ì…ë ¥ì„ ë°›ëŠ” ë…¸ë“œ (Human-in-the-Loop!)
    
    ì—­í• :
        - LLMì˜ ì§ˆë¬¸ì„ ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì¤Œ
        - ì‚¬ìš©ìì˜ ë‹µë³€ì„ ë°›ì•„ì„œ ìƒíƒœì— ì €ì¥
    
    ë¹„ìœ :
        ì›¨ì´í„°ê°€ "ë§¤ìš´ë§› ì–´ëŠ ì •ë„ë¡œ í•˜ì‹œê² ì–´ìš”?" ë¬¼ì–´ë³´ê³ 
        ì†ë‹˜ì˜ ëŒ€ë‹µì„ ê¸°ë‹¤ë¦¬ëŠ” ê²ƒ
    
    âš ï¸ í•µì‹¬: ì—¬ê¸°ì„œ ì›Œí¬í”Œë¡œìš°ê°€ ë©ˆì¶”ê³  ì‚¬ëŒì˜ ì…ë ¥ì„ ê¸°ë‹¤ë¦½ë‹ˆë‹¤!
    """
    print("\n" + "ğŸ””"*30)
    print("ğŸ‘¤ [ì‚¬ëŒ ë…¸ë“œ] AIê°€ ì¶”ê°€ ì •ë³´ë¥¼ ìš”ì²­í–ˆìŠµë‹ˆë‹¤!")
    print("ğŸ””"*60)
    print(f"\nâ“ AIì˜ ì§ˆë¬¸: {state.response}")
    print("\nğŸ’­ ìœ„ ì§ˆë¬¸ì— ë‹µë³€í•´ì£¼ì„¸ìš”:")
    
    # â­ í•µì‹¬: input()ìœ¼ë¡œ ì›Œí¬í”Œë¡œìš°ê°€ ë©ˆì¶”ê³  ì‚¬ìš©ì ì…ë ¥ ëŒ€ê¸°!
    user_input = input("ë‹µë³€ ğŸ‘‰ ")
    
    print(f"\nâœ… ë‹µë³€ ë°›ìŒ: {user_input}")
    print("ğŸ””"*60)
    
    return {
        "task_details": user_input
    }


# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# 4ï¸âƒ£ ë¼ìš°íŒ… í•¨ìˆ˜: ë‹¤ìŒì— ì–´ë””ë¡œ ê°ˆì§€ ê²°ì •
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
def route_after_llm(state: AgentState) -> Literal["need_human_input", "done"]:
    """
    ğŸ§­ ë¼ìš°í„°: LLM ì‘ë‹µì„ ë¶„ì„í•´ì„œ ë‹¤ìŒ ë‹¨ê³„ ê²°ì •
    
    ê²°ì • ê¸°ì¤€:
        - ì‘ë‹µì´ '?'ë¡œ ëë‚˜ë©´ â†’ ì§ˆë¬¸ì´ë‹¤ â†’ ì‚¬ëŒì—ê²Œ ë¬¼ì–´ë´ì•¼ í•¨
        - ì‘ë‹µì´ '?'ë¡œ ì•ˆ ëë‚˜ë©´ â†’ ìµœì¢… ë‹µë³€ì´ë‹¤ â†’ ì™„ë£Œ!
    
    ë¹„ìœ :
        êµí†µ ì‹ í˜¸ë“±ì´ ë¹¨ê°„ë¶ˆì¸ì§€ ì´ˆë¡ë¶ˆì¸ì§€ í™•ì¸í•´ì„œ
        ë©ˆì¶œì§€ ê³„ì† ê°ˆì§€ ê²°ì •í•˜ëŠ” ê²ƒ
    """
    print("\n" + "ğŸ§­"*30)
    print("ğŸ§­ [ë¼ìš°í„°] ë‹¤ìŒ ë‹¨ê³„ë¥¼ ê²°ì •í•©ë‹ˆë‹¤...")
    print("ğŸ§­"*60)
    
    response = state.response.strip()
    
    # ì‘ë‹µì´ ë¬¼ìŒí‘œë¡œ ëë‚˜ëŠ”ì§€ í™•ì¸
    if response.endswith("?"):
        print("ğŸ“Œ íŒë‹¨: ì‘ë‹µì´ '?'ë¡œ ëë‚¨ â†’ AIê°€ ì§ˆë¬¸í•¨")
        print("ğŸ”„ ê²°ì •: ì‚¬ëŒì—ê²Œ ì…ë ¥ì„ ë°›ìœ¼ëŸ¬ ê°‘ë‹ˆë‹¤ (Human-in-the-Loop!)")
        print("ğŸ§­"*60)
        return "need_human_input"
    else:
        print("ğŸ“Œ íŒë‹¨: ì‘ë‹µì´ '?'ë¡œ ì•ˆ ëë‚¨ â†’ ìµœì¢… ë‹µë³€ì„")
        print("âœ… ê²°ì •: ì‘ì—… ì™„ë£Œ! ì›Œí¬í”Œë¡œìš° ì¢…ë£Œ")
        print("ğŸ§­"*60)
        return "done"


# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# 5ï¸âƒ£ ê·¸ë˜í”„ ìƒì„±: ë…¸ë“œë“¤ì„ ì—°ê²°
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
def create_graph():
    """
    ğŸ—ï¸ Human-in-the-Loop ì›Œí¬í”Œë¡œìš° ê·¸ë˜í”„ ìƒì„±
    
    ê·¸ë˜í”„ íë¦„:
        START
          â†“
        [AI ë…¸ë“œ] â† â”€â”€â”€â”€â”€â”
          â†“               â”‚
        {ë¼ìš°í„°}          â”‚
          â†“ â†˜            â”‚
          â†“   â†˜          â”‚
          â†“     [ì‚¬ëŒ ë…¸ë“œ]
          â†“        â†“      â”‚
         END    â”€â”€â”€â”˜      â”‚
                          â”‚
        (ë£¨í”„: ì‚¬ëŒâ†’AIâ†’ì‚¬ëŒâ†’AI... ë°˜ë³µ ê°€ëŠ¥!)
    """
    # LLM ì´ˆê¸°í™”
    llm = init_chat_model("gpt-4o-mini", model_provider="openai")
    
    # LLMì„ í´ë¡œì €ë¡œ ìº¡ì²˜í•˜ëŠ” ë˜í¼ í•¨ìˆ˜
    def llm_node_with_llm(state):
        return llm_node(state, llm)
    
    # ê·¸ë˜í”„ ìƒì„±
    workflow = StateGraph(AgentState)
    
    # ë…¸ë“œ ì¶”ê°€
    workflow.add_node("ai", llm_node_with_llm)         # AIê°€ ìƒê°í•˜ëŠ” ë…¸ë“œ
    workflow.add_node("human", human_input_node)       # ì‚¬ëŒì´ ì…ë ¥í•˜ëŠ” ë…¸ë“œ
    
    # ì—£ì§€ ì—°ê²°
    workflow.add_edge(START, "ai")                     # ì‹œì‘ â†’ AI
    
    # ì¡°ê±´ë¶€ ì—£ì§€: AI ì‘ë‹µì„ ë³´ê³  ë‹¤ìŒ ë‹¨ê³„ ê²°ì •
    workflow.add_conditional_edges(
        "ai",                    # AI ë…¸ë“œ ë‹¤ìŒì—
        route_after_llm,         # ë¼ìš°í„° í•¨ìˆ˜ë¡œ íŒë‹¨
        {
            "need_human_input": "human",   # ì§ˆë¬¸ì´ë©´ â†’ ì‚¬ëŒ ë…¸ë“œë¡œ
            "done": END                    # ì™„ë£Œë©´ â†’ ì¢…ë£Œ
        }
    )
    
    # ì‚¬ëŒ ë…¸ë“œ ë‹¤ìŒì—ëŠ” ë‹¤ì‹œ AIë¡œ (ë£¨í”„!)
    workflow.add_edge("human", "ai")
    
    return workflow.compile()


# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# 6ï¸âƒ£ ì‹¤í–‰
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
def main():
    print("â•”" + "="*58 + "â•—")
    print("â•‘" + " "*10 + "ğŸ”„ Human-in-the-Loop ìƒì„¸ ì„¤ëª… ì˜ˆì œ" + " "*10 + "â•‘")
    print("â•š" + "="*58 + "â•")
    
    print("""
ğŸ’¡ ì´ ì˜ˆì œì˜ íë¦„:
    1. ì‚¬ìš©ì: "ë¸”ë¡œê·¸ ê¸€ ì‘ì„±" ìš”ì²­
    2. AI: "ì–´ë–¤ ì£¼ì œì¸ê°€ìš”?" (ì§ˆë¬¸) â† ì •ë³´ ë¶€ì¡±!
    3. ğŸ‘¤ ì‚¬ëŒ: "íŒŒì´ì¬ íŠœí† ë¦¬ì–¼" ì…ë ¥ â† Human-in-the-Loop!
    4. AI: ìµœì¢… ë³´ê³ ì„œ ì‘ì„± (ì™„ë£Œ)
    
âš ï¸ í•µì‹¬ í¬ì¸íŠ¸:
    - 3ë²ˆ ë‹¨ê³„ì—ì„œ ì›Œí¬í”Œë¡œìš°ê°€ ë©ˆì¶”ê³  ì‚¬ëŒì˜ ì…ë ¥ì„ ê¸°ë‹¤ë¦½ë‹ˆë‹¤
    - ì‚¬ëŒì´ ë‹µë³€í•˜ë©´ ë‹¤ì‹œ ì›Œí¬í”Œë¡œìš°ê°€ ê³„ì†ë©ë‹ˆë‹¤
    - ì´ê²ƒì´ "Human-in-the-Loop"ì…ë‹ˆë‹¤!
""")
    
    # ê·¸ë˜í”„ ìƒì„±
    app = create_graph()
    
    # ì´ˆê¸° ìƒíƒœë¡œ ì‹¤í–‰
    initial_state = AgentState(user_message="ë¸”ë¡œê·¸ ê¸€ ì‘ì„±")
    
    print("\nğŸš€ ì›Œí¬í”Œë¡œìš° ì‹œì‘!\n")
    final_state = app.invoke(initial_state)
    
    # ìµœì¢… ê²°ê³¼
    print("\n" + "ğŸ‰"*30)
    print("ğŸ‰ ì›Œí¬í”Œë¡œìš° ì™„ë£Œ!")
    print("ğŸ‰"*60)
    print(f"\nğŸ“ ìµœì¢… ì‘ë‹µ:\n")
    print(final_state["response"])
    print(f"\nğŸ“Š ì´ ëŒ€í™” íšŸìˆ˜: {final_state['interaction_count']}íšŒ")
    print("\n" + "ğŸ‰"*60)
    
    # ê·¸ë˜í”„ ì‹œê°í™” (ì„ íƒì‚¬í•­)
    try:
        mermaid_png = app.get_graph().draw_mermaid_png()
        with open("./07_human_in_loop_explained.png", "wb") as f:
            f.write(mermaid_png)
        print("\nğŸ’¾ ê·¸ë˜í”„ ì´ë¯¸ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤: 07_human_in_loop_explained.png")
    except Exception as e:
        print(f"\nâš ï¸ ê·¸ë˜í”„ ì‹œê°í™” ì‹¤íŒ¨: {e}")


if __name__ == "__main__":
    main()

